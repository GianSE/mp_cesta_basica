#!/bin/bash
echo "üõ°Ô∏è  [Git Hook] Iniciando bateria de testes inteligente..."

# 1. Pega apenas arquivos Python (.py) que est√£o Staged (prontos para commit)
# --diff-filter=ACM ignora arquivos deletados (D)
FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "\.py$")

# 2. Se n√£o tiver arquivos Python modificados, pula a valida√ß√£o
if [ -z "$FILES" ]; then
    echo "‚è© Nenhum arquivo Python modificado. Pulando verifica√ß√£o de imports."
    exit 0
fi

# --- ETAPA 1: VALIDAR IMPORTS (Apenas Modificados) ---
CHECK_SCRIPT="_ops/check_imports.py"

if [ -f "$CHECK_SCRIPT" ]; then
    echo "üîç Verificando imports em:"
    echo "$FILES" | sed 's/^/   - /' # Lista bonitinha os arquivos
    
    # Passa a lista de arquivos como argumentos para o script Python
    # O Python precisa estar preparado para receber argumentos!
    python "$CHECK_SCRIPT" $FILES
    
    if [ $? -ne 0 ]; then
        echo "‚ùå [FALHA] Erro de importa√ß√£o detectado nos arquivos acima."
        echo "   Corrija o erro antes de comitar."
        exit 1
    fi
else
    echo "‚ö†Ô∏è  Script $CHECK_SCRIPT n√£o encontrado. Pulando etapa."
fi

echo "‚úÖ TUDO LIMPO! Commit autorizado."
exit 0